name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: scintirete/webapp

jobs:
  # Docker é•œåƒæž„å»ºå’ŒæŽ¨é€
  docker:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # åˆ›å»º GitHub Release
  create-release:
    needs: [docker]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Create release notes
        cat > release_notes.md << 'EOF'
        ## Scintirete WebApp ${{ github.ref_name }}
        
        **Scintirete WebApp** - åŸºäºŽ Next.js çš„å‘é‡æ•°æ®åº“ç®¡ç†ç•Œé¢
        
        ### ðŸ³ Docker é•œåƒ
        
        Docker é•œåƒå·²è‡ªåŠ¨æŽ¨é€åˆ° GitHub Container Registryï¼š
        
        ```bash
        # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
        docker pull ghcr.io/scintirete/webapp:${{ github.ref_name }}
        
        # æ‹‰å– latest ç‰ˆæœ¬
        docker pull ghcr.io/scintirete/webapp:latest
        ```
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        #### ä½¿ç”¨ Docker Compose (æŽ¨è)
        ```bash
        # ä¸‹è½½ docker-compose.yaml
        wget https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yaml
        
        # å¯åŠ¨æœåŠ¡
        docker-compose up -d
        ```
        
        #### ç›´æŽ¥è¿è¡Œ
        ```bash
        docker run -d \
          --name scintirete-webapp \
          -p 3000:3000 \
          ghcr.io/scintirete/webapp:${{ github.ref_name }}
        ```
        
        ### ðŸ“ çŽ¯å¢ƒå˜é‡é…ç½®
        
        åº”ç”¨æ”¯æŒä»¥ä¸‹çŽ¯å¢ƒå˜é‡ï¼š
        - `HOSTNAME`: ç»‘å®šä¸»æœºåœ°å€ï¼ˆé»˜è®¤: 0.0.0.0ï¼‰
        - `PORT`: ç«¯å£å·ï¼ˆé»˜è®¤: 3000ï¼‰
        - `NODE_ENV`: è¿è¡ŒçŽ¯å¢ƒï¼ˆproduction/developmentï¼‰
        
        ### ðŸ”— è®¿é—®åº”ç”¨
        
        å¯åŠ¨åŽè®¿é—® http://localhost:3000 å³å¯ä½¿ç”¨ç®¡ç†ç•Œé¢ã€‚
        
        ### âœ¨ ä¸»è¦åŠŸèƒ½
        
        - ðŸŒ å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
        - ðŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
        - ðŸŽ¨ çŽ°ä»£åŒ– UI è®¾è®¡
        - ðŸ“Š å‘é‡æ•°æ®åº“ç®¡ç†åŠŸèƒ½
        - ðŸ”§ æ˜“äºŽéƒ¨ç½²å’Œé…ç½®
        
        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹æäº¤è®°å½•ã€‚**
        EOF
        
        # Check if it's a pre-release (contains dev, alpha, beta, rc)
        if [[ "${{ github.ref_name }}" =~ (dev|alpha|beta|rc) ]]; then
          PRERELEASE_FLAG="--prerelease"
        else
          PRERELEASE_FLAG=""
        fi
        
        # Create release using gh CLI
        gh release create "${{ github.ref_name }}" \
          --title "WebApp ${{ github.ref_name }}" \
          --notes-file release_notes.md \
          $PRERELEASE_FLAG